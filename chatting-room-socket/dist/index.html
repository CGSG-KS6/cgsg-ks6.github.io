<!doctype html>
<html>

<head>
  <title>Messenger</title>
  <link rel="stylesheet" href="client.css">

  <script src="/socket.io/socket.io.js"></script>
  <script>
    var socket = io();

    //
    //  Sending messages
    //
    function sendMessage() {
      const name_changer = document.getElementById("inputElementName");
      const message_changer = document.getElementById("inputElementMessage");

      let msg = { name: name_changer.value, message: message_changer.value };
      msg.message = msg.message.trim();
      msg.message = msg.message.slice(0, 1000);
      msg.name = msg.name.trim();
      msg.name = msg.name.slice(0, 20);

      if (msg.name && msg.message) {
        socket.emit('message', JSON.stringify(msg));
        message_changer.value = "";
      }
    }

    //
    //  Getting messages
    //
    function messagePlace(message) {
      const message_display = document.getElementById("panelMessagesDiaplay");

      let message_element = document.createElement("div");
      let message_author_element = document.createElement("p");
      let message_data = document.createElement("a");

      message_author_element.innerText = message.name;
      message_author_element.classList.add("author");
      message_data.innerText = message.message;
      message_data.classList.add("data");

      message_element.classList.add("messageBox");
      message_element.appendChild(message_author_element);
      message_element.appendChild(message_data);
      message_display.appendChild(message_element);
      message_display.scrollTop = message_display.scrollHeight;
    }

    socket.on('message', (msg) => {
      console.log(msg);
      messagePlace(JSON.parse(msg));
    });

    //
    //  Button showing
    //
    function buttonShowing() {
      const send_but = document.getElementById("inputElementSendMessage");
      const label = document.getElementById("labelSendMessage");
      const message_changer = document.getElementById("inputElementMessage");
      const name_changer = document.getElementById("inputElementName");

      if (message_changer.value && name_changer.value) {
        send_but.style.display = "inline-block";
        label.style.display = "inline-block";
      } else {
        send_but.style.display = "none";
        label.style.display = "none";
      }

      if (message_changer.value) {
        message_changer.style.height = "15vh";
      } else {
        message_changer.style.height = "2.5vh";
      }
    }

    function getCookie(name) {
      let matches = document.cookie.match(new RegExp(
        "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
      ));
      return matches ? decodeURIComponent(matches[1]) : undefined;
    }

    //
    //  Setting name to cookie
    //
    function setNameCookie() {
      const name_changer = document.getElementById("inputElementName");
      document.cookie = `name=${name_changer.value}`;
    }

    //
    //  onLoad
    //
    function onLoad() {
      const name_changer = document.getElementById("inputElementName");
      let name_fromm_cookie = getCookie('name');;
      if (name_fromm_cookie) name_changer.value = name_fromm_cookie;
    }
  </script>
</head>

<body onload="onLoad();">
  <div id="panelMessageSending">
    <p id="titleMessgeSending" class="title">Message<br>sending</p>
    <input id="inputElementName" class="text textInput" type="title" placeholder="name" oninput="buttonShowing();"
      onchange="setNameCookie();">
    <textarea id="inputElementMessage" class="text textInput" placeholder="message"
      onkeyup="if (event.keyCode == 13 && !event.shiftKey) { sendMessage(); buttonShowing(); };"
      oninput="buttonShowing()"></textarea>
    <input id="inputElementSendMessage" class="title button" type="button" onclick="sendMessage(); buttonShowing();"
      style="display: none;" value="&#10149;"><label style="display: none;" id="labelSendMessage"
      class="text">SEND</label>
  </div>

  <div id="panelMessagesDiaplay">
    <p id="titleMessagesDiaplay" class="title">Messages</p>
  </div>
</body>

</html>